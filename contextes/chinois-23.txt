
   Router Lab 实验文档
   邻居发现协议与邻居缓存

   ____________________
--
          + 总述
          + 开始实验
          + [ ] 邻居发现协议与邻居缓存 邻居发现协议与邻居缓存
        目录
               o IPv6 地址分类
               o 路由器地址配置
               o 邻居发现协议处理
                    # ND 报文接收
                    # Neighbor Advertisement 发送
               o 邻居缓存设计与实现
          + 转发表
          + 转发引擎
--
     * IPv6 地址分类
     * 路由器地址配置
     * 邻居发现协议处理
          + ND 报文接收
          + Neighbor Advertisement 发送
     * 邻居缓存设计与实现

第二阶段：邻居发现协议与邻居缓存¶

IPv6 地址分类¶

   为了方便实验者阅读理解邻居发现协议（ND），本节首先对 IPv6 的地址分类进行一些介绍。

   IPv6 地址有三种类型，分别为单播地址、任播地址以及组播地址：
--
   在实践中，在网络层配置好 IP 地址后，网络节点还需要进行重复地址检测并加入相应组播组。在本实验中，这一过程可以省略。

邻居发现协议处理¶

   路由器工作在网络层（三层，采用 IP 协议），之下的数据链路层（二层，本实验基于以太网）为网络层提供 服务。网络层使用 IP
   地址标识不同的网络节点，而数据链路层则使用 MAC 地址（链路层地址）进行以太网帧的转发。因此，网络节点在发送和转发 IP 分组时，仅根据目的
   IP 地址确定下一跳 IP 地址是不够的。为了能够将 IP 分组通过以太网发送至下一跳节点，网络节点还需要知道下一跳的 MAC
   地址。邻居发现协议能够实现 IP 地址到 MAC 地址的转换这一地址解析（Address Resolution）过程。

   事实上，本实验中，实验者可以把 ND 协议处理实现在硬件中，也可以实现在软件中。本实验建议 ND
   协议采用硬件实现，其优点为方便调试，不需要等到 CPU
   及软件实现完毕后再进行调试；但是，如果软件需要访问邻居缓存（事实上，在本实验中一般不需要），则需要额外的工作。

   总体而言，实验者至少需要实现 ND 报文的以下处理，以便与其他网络节点互联互通：
--
       地址进行重复地址检测（Duplicate Address Detection，DAD），此时 ND
       报文的源地址为未指定地址。其中，实验者可以不实现对于后一种情况的处理，但是需要正确地丢弃这样的报文。
     * 单播 Neighbor Solicitation 接收与处理：其他节点正在针对该 IP 地址进行邻居不可达检测（Neighbor
       Unreachability Detection，NUD）。顺便指出，本实验中，实验者可以不实现单播 Neighbor
       Solicitation 的发送，即可以不主动进行 NUD，但是需要响应 NUD。
--
       Advertisement，由于其为组播，被当前节点接收。实验者需要正确地丢弃这样的报文。

   特别地，实验者可以不实现邻居缓存表项的状态维护（Neighbor Cache Entry
   States）。此外，实验者可以不实现对于任播地址，包括子网路由器任播地址的 Neighbor Solicitation 的接收与处理。

   邻居发现协议的更多细节请参见 RFC 4861: Neighbor Discovery for IP version 6
   (IPv6)，实验者可以重点关注第 4.3、4.4、4.6.1、7.1、7.2.2、7.2.3、7.2.4 以及 7.2.5 小节。

--
   与 Loopback 不同，在本节中，实验者需要对收到的以太网帧进行解析，判断其 EtherType。如果该帧是一个合法的 ND
   报文，则实验者需要正确提取出发送者的 MAC 地址（源或目标链路层地址选项）以及 IP 地址（视情况选择源 IP 地址或 Target
   Address），然后更新或插入到邻居缓存中。此处的更新是指，当邻居缓存中存在对应 IP 地址的条目时，更新其 MAC
   地址，当不存在时，插入该 IP 地址和 MAC 地址的对应关系；插入是指，当邻居缓存中存在对应 IP 地址的条目时，不改变其 MAC
   地址，当不存在时，插入该 IP 地址和 MAC 地址的对应关系。当处理完成后，实验者即可将此 ND
   报文丢弃。实现完成后，实验者可以通过仿真来进行测试，然后使用 ILA 在实验板上进行观察。
--
    4. 操作系统一般会在什么情况下发送 ND 报文到路由器？
    5. 如何向操作系统添加一条指向实验路由器的路由表项？
    6. 何时 更新 邻居缓存表项？何时 插入 邻居缓存表项？

Neighbor Advertisement 发送¶
--
       地址等）应当如何填写？

邻居缓存设计与实现¶

   邻居缓存负责缓存 IP 地址与 MAC
   地址的对应关系。与转发表不同，邻居缓存的匹配算法采用精确匹配，因此较为简单。根据本实验的实际情况，邻居缓存所需支持的容量无需太大，十余条即可。
   实现邻居缓存时，实验者可以采用 CAM（Content-Addressable
   Memory）、蛮力查找或散列表等数据结构，同时可以加入过期自动删除的功能。其中，实验者也可以不实现过期自动删除的功能。

   实验者需要为邻居缓存设计好接口，写好 testbench，并进行充分测试。

   思考
    1. 如何实现过期自动删除的功能？
    2. IP 地址会有局部性吗？
    3. 如何处理邻居缓存满的情况？
     __________________________________________________________________

